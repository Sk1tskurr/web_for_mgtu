<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Основная страница</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div id="loading" style="display:none;">
    <img src="images/loading.gif" alt="Loading...">
</div>

<!-- Навигационная панель -->
<header>
    <div class="nav-container">
        <!-- Лого -->
        <div class="logo">
            <img src="/images/logo.png" alt="Logo">
        </div>

        <!-- Меню навигации -->
        <nav>
            <ul>
                <li><a href="/main">Главная</a></li>
                <div id="apocalypse-container"></div>
            </ul>
        </nav>

        <!-- Профиль -->
        <div class="profile">
            <!-- Тут мог быть маршрут профиля, чтобы пользователь мог менять что нибудь типа своего пароля, но в другой раз -->
            <!--<a href="/profile">Профиль</a>-->
            <a href="#" id="logout">Выход</a>
        </div>
    </div>
</header>

<!-- Контейнер основной страницы -->
<div class="maine_page-container">
    <!-- Таблица -->
    <div class="table-wrapper">
        <table id="data-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Имя</th>
                <th>Пароль</th>
                <th>Какой то текст</th>
                <th>Дата</th>
            </tr>
            </thead>
            <tbody>
            <!-- Данные будут добавлены сюда -->
            </tbody>
        </table>
    </div>

    <!-- Контейнер для кнопок(пустой) -->
    <div class="button-container"></div>

    <!-- Модальное окно для работы со строками -->
    <div id="mainPageModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <form id="modalForm">
                <div>
                    <label for="modalId" id="labelId" style="display: none;">Id:</label>
                    <input type="text" id="modalId" readonly style="display: none;">
                </div>
                <div>
                    <label for="modalLogin">Логин:</label>
                    <input type="text" id="modalLogin">
                </div>
                <div>
                    <label for="modalPassword">Пароль:</label>
                    <input type="text" id="modalPassword">
                </div>
                <div>
                    <label for="modalDescription">Описание:</label>
                    <input type="text" id="modalDescription">
                </div>
                <div>
                    <label for="modalDate" id="labelDate" style="display: none;">Дата регистрации:</label>
                    <input type="text" id="modalDate">
                </div>
                <button type="submit">Сохранить</button>
            </form>
        </div>
    </div>
</div>

<script src="js/loading.js"></script>

<script>
    let selectedRowId = null;
    let selectedRowData = null;

    // Получаем данные о пользователе из сессии
    fetch('/session-data')
        .then(response => response.json())
        .then(sessionData => {
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = '/apocalypse';

            if (sessionData.username === 'admin') {
                link.textContent = 'ЖМИ, ОНИ ЭТОГО ЗАСЛУЖИЛИ';

                // Добавляем кнопки в контейнер кнопок
                const addButton = document.createElement('button');
                addButton.textContent = 'Добавить';
                addButton.onclick = function() { add_string(); };
                document.querySelector('.button-container').appendChild(addButton);

                const editButton = document.createElement('button');
                editButton.textContent = 'Изменить';
                editButton.onclick = function() { edit_string(); };
                document.querySelector('.button-container').appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Удалить';
                deleteButton.onclick = function() { delete_string(); };
                document.querySelector('.button-container').appendChild(deleteButton);

            } else {
                link.textContent = 'НЕ НАЖИМАТЬ';
            }

            listItem.appendChild(link);
            document.getElementById('apocalypse-container').appendChild(listItem);

            // Получаем содержимое таблицы
            fetch('/get_table_content')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('data-table').querySelector('tbody');
                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        const passwordDisplay = sessionData.username === 'admin' ? row.password : '******';
                        tr.innerHTML = `
                        <td>${row.id}</td>
                        <td>${row.login}</td>
                        <td>${passwordDisplay}</td>
                        <td>${row.description}</td>
                        <td>${row.date}</td>
                    `;
                        tr.addEventListener('click', function() {
                            tableBody.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
                            tr.classList.add('selected');
                            selectedRowId = row.id;
                            selectedRowData = row;
                        });
                        tableBody.appendChild(tr);
                    });
                })
                .catch(error => console.error('Ошибка:', error));
        })
        .catch(error => console.error('Ошибка получения данных о сессии:', error));

    function refresh_table_action() {
        fetch('/get_table_content')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('data-table').querySelector('tbody');
                tableBody.innerHTML = ''; // Очистка предыдущих данных из таблицы

                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${row.login}</td>
                    <td>${row.password}</td>
                    <td>${row.description}</td>
                    <td>${row.date}</td>
                `;

                    tr.addEventListener('click', function() {
                        tableBody.querySelectorAll('tr').forEach(row => row.classList.remove('selected'));
                        tr.classList.add('selected');
                        selectedRowId = row.id;
                        selectedRowData = row;
                    });

                    tableBody.appendChild(tr);
                });
            })
            .catch(error => console.error('Ошибка:', error));
    }


    const modal = document.getElementById("mainPageModal");
    const closeModal = document.getElementsByClassName("close")[0];

    // Открытие модального окна добавления записи
    function add_string() {
        document.getElementById("modalForm").reset();
        document.getElementById("modalId").value = '';
        document.getElementById("modalDate").readOnly = true;
        document.getElementById("modalDate").style.display = "none";
        modal.style.display = "flex";
    }

    // Открытие модального окна редактирования записи
    function edit_string() {
        if (selectedRowData) {

            document.getElementById("labelId").style.display = "block";
            document.getElementById("modalId").style.display = "block";
            document.getElementById("modalId").value = selectedRowData.id;
            document.getElementById("modalPassword").value = selectedRowData.password;
            document.getElementById("modalLogin").value = selectedRowData.login;
            document.getElementById("modalDescription").value = selectedRowData.description;
            document.getElementById("modalDate").readOnly = true;
            document.getElementById("modalDate").style.display = "block";
            document.getElementById("labelDate").style.display = "block";
            document.getElementById("modalDate").value = selectedRowData.date;

            modal.style.display = "flex";
        } else {
            alert("Пожалуйста, выберите строку для изменения.");
        }
    }
    // Удаление строки
    function delete_string() {
        if (selectedRowId) {
            if (confirm(`Вы уверены, что хотите удалить строку с ID: ${selectedRowId}?`)) {
                fetch('/delete-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: selectedRowId })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert('Строка успешно удалена');
                            // Здесь можно обновить таблицу, но пока не до того
                            refresh_table_action()
                        } else {
                            alert('Ошибка при удалении строки');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                    });
            }
        } else {
            alert("Пожалуйста, выберите строку для удаления.");
        }
    }

    document.getElementById('modalForm').addEventListener('submit', function(event) {
        event.preventDefault();

        // Получаем текущее время
        const currentDate = new Date();

        // Форматируем дату в нужном формате
        const day = String(currentDate.getDate()).padStart(2, '0');
        const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // Месяцы начинаются с 0
        const year = currentDate.getFullYear();
        const hours = String(currentDate.getHours()).padStart(2, '0');
        const minutes = String(currentDate.getMinutes()).padStart(2, '0');

        // Склеиваем в строку нужного формата
        const formattedDate = `${day}.${month}.${year} ${hours}:${minutes}`;

        // Записываем отформатированную дату в элемент modalDate
        document.getElementById("modalDate").value = formattedDate;
        const id = document.getElementById('modalId').value;
        const login = document.getElementById('modalLogin').value;
        const password = document.getElementById('modalPassword').value;
        const description = document.getElementById('modalDescription').value;
        const date = document.getElementById('modalDate').value;

        // Исправлено условие проверки заполненности полей
        if (!login || !password || !description || !date) {
            alert('Все поля должны быть заполнены');
            return;
        }

        const data = { id, login, password, description, date };

        fetch('/save-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Данные успешно сохранены');
                    document.getElementById('modalForm').reset(); // Очистка формы
                    modal.style.display = "none"; // Закрытие модального окна
                    document.getElementById("modalId").style.display = "none";
                    document.getElementById("labelId").style.display = "none";
                    document.getElementById("modalDate").style.display = "none";
                    document.getElementById("labelDate").style.display = "none";
                    refresh_table_action(); // Обновление таблицы
                } else {
                    alert('Ошибка при сохранении данных');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
            });
    });


    // Закрытие модального окна
    closeModal.onclick = function() {
        modal.style.display = "none";
        document.getElementById("modalId").style.display = "none";
        document.getElementById("labelId").style.display = "none";
        document.getElementById("modalDate").style.display = "none";
        document.getElementById("labelDate").style.display = "none";
    }

    // Выход из сессии
    document.getElementById('logout').addEventListener('click', function(event) {
        event.preventDefault(); // Предотвращаем переход по ссылке

        fetch('/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Перенаправление на страницу входа
                    window.location.href = '/login';
                } else {
                    alert('Ошибка при выходе из системы');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
            });
    });
</script>
</body>
</html>
